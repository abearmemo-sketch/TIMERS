<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>計時器簡易版</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { 
    font-family: 'Inter', sans-serif; 
    background-color: rgba(0,0,0,0.05); 
    color: #333; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    min-height: 100vh; 
    padding: 1rem;
  }
  #timer { font-family: 'Roboto Mono', monospace; font-size: 2.5rem; font-weight: bold; }
  #task-desc { font-size: 1.25rem; margin-top: 0.5rem; margin-bottom: 1rem; word-break: break-word; }
  button { background-color: #666; color: #fff; padding: 0.5rem 1rem; border-radius: 0.25rem; }
  button:hover { background-color: #444; cursor: pointer; }
</style>
</head>
<body>

<div class="flex flex-col items-center gap-4 w-full max-w-sm">
  <div id="task-desc">讀取中...</div>
  <div id="timer">00:00:00</div>
  <button id="update-btn">更新</button>
</div>

<script>
const SAVE_API = "/api/saveEntry";
const TOGGL_API = "/api/TTTT";

const taskDescDiv = document.getElementById("task-desc");
const timerDiv = document.getElementById("timer");
const updateBtn = document.getElementById("update-btn");

let startTime = null;
let intervalId = null;

function pad(num) { return String(num).padStart(2,'0'); }

function updateTimer() {
  if (!startTime) return;
  const now = new Date();
  const diff = Math.floor((now - startTime)/1000);
  const hours = pad(Math.floor(diff/3600));
  const minutes = pad(Math.floor((diff%3600)/60));
  const seconds = pad(diff%60);
  timerDiv.textContent = `${hours}:${minutes}:${seconds}`;
}

async function loadSavedEntry() {
  try {
    const res = await fetch(SAVE_API);
    const data = await res.json();
    if (data.start && data.description) {
      taskDescDiv.textContent = data.description;
      startTime = new Date(data.start.replace(' ', 'T'));
      if (intervalId) clearInterval(intervalId);
      updateTimer();
      intervalId = setInterval(updateTimer, 1000);
    } else {
      taskDescDiv.textContent = "尚無計時資料";
      timerDiv.textContent = "00:00:00";
      startTime = null;
    }
  } catch(err) {
    console.error(err);
    taskDescDiv.textContent = "讀取暫存資料失敗";
    timerDiv.textContent = "00:00:00";
  }
}

async function fetchTimeEntry() {
  try {
    const res = await fetch(TOGGL_API);
    const data = await res.json();
    if (data.current_timer && data.current_timer.id) {
      const entry = {
        start: data.current_timer.start,
        description: data.current_timer.description || "（無描述）"
      };
      taskDescDiv.textContent = entry.description;
      startTime = new Date(entry.start);

      // 更新暫存
      await fetch(SAVE_API, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ start: entry.start, description: entry.description })
      });

      if (intervalId) clearInterval(intervalId);
      updateTimer();
      intervalId = setInterval(updateTimer, 1000);

      // 同步到 Notion
      await fetch("/api/notionPush", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ task: entry.description, startDate: entry.start })
      });
    } else {
      taskDescDiv.textContent = "目前沒有計時中項目";
      timerDiv.textContent = "00:00:00";
      startTime = null;
    }
  } catch(err) {
    console.error(err);
    taskDescDiv.textContent = "抓取失敗";
  }
}

updateBtn.addEventListener("click", fetchTimeEntry);
window.onload = loadSavedEntry;
</script>

</body>
</html>
