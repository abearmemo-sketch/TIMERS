<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toggl 計時器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 定義統一的灰色系 */
        :root {
            --text-dark-gray: #4a4a4a; /* 深一點的灰色，用於標題和計時器 */
            --text-medium-gray: #7a7a7a; /* 中等灰色，用於描述和狀態 */
            --button-bg-gray: #808080; /* 按鈕背景灰色 */
            --button-hover-gray: #555555; /* 按鈕hover灰色 */
            --divider-color: #cccccc; /* 分隔線顏色 */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            /* 移除背景色，實現透明底色 */
            background-color: transparent; 
            color: var(--text-dark-gray); /* 預設文字色 */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            /* 讓內容不會貼邊，有呼吸空間 */
            padding: 2rem; 
            box-sizing: border-box; /* 確保padding不會超出100vh */
        }
        
        /* 移除卡片容器的樣式，使其透明無邊框 */
        .container { /* 改用更通用的container類名 */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 450px;
            text-align: center;
            /* 移除背景、陰影、邊框 */
            /* background-color: transparent; */ 
            /* border-radius: 0; */
            /* box-shadow: none; */
            /* padding: 0; */ /* 內部元素自己控制間距 */
        }

        /* 計時器樣式 */
        #timer {
            font-family: 'Roboto Mono', monospace;
            font-size: 5rem;
            font-weight: 700;
            color: var(--text-dark-gray); /* 計時器也使用深灰色 */
            margin-top: 1rem;
            margin-bottom: 2rem;
            letter-spacing: -2px;
        }

        /* 任務描述和開始時間樣式 */
        #task-desc, #start-time {
            font-size: 1.125rem;
            color: var(--text-medium-gray); /* 使用中等灰色 */
            margin-bottom: 0.5rem;
        }
        #task-desc {
            font-weight: 700;
        }

        /* 按鈕樣式 */
        button {
            background-color: var(--button-bg-gray); /* 按鈕背景灰色 */
            color: white; /* 按鈕文字為白色，確保在灰色背景上可讀 */
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
            margin-top: 1.5rem;
        }
        button:hover {
            background-color: var(--button-hover-gray); /* 按鈕hover變深灰色 */
        }

        /* 狀態訊息樣式 */
        #status {
            margin-top: 1rem;
            color: var(--text-medium-gray); /* 狀態訊息使用中等灰色 */
            font-size: 0.875rem;
        }
        
        .divider {
            height: 1px;
            background-color: var(--divider-color); /* 分隔線顏色 */
            width: 80%; /* 讓分隔線不要滿寬度，更雅緻 */
            margin: 1.5rem 0;
        }
    </style>
</head>
<body>

<div class="container"> <div id="start-time">--:--</div>
    <div id="task-desc">無任務</div>
    <div class="divider"></div>
    <div id="timer">00:00:00</div>
    <div class="divider"></div>
    <button id="update-btn">更新資訊</button>
    <div id="status"></div>
</div>

<script>
    const TOGGL_API = "/api/TTTT";
    const SAVE_API = "/api/saveEntry";
    
    const startTimeDiv = document.getElementById("start-time");
    const taskDescDiv = document.getElementById("task-desc");
    const timerDiv = document.getElementById("timer");
    const updateBtn = document.getElementById("update-btn");
    const statusDiv = document.getElementById("status");

    let startTime = null;
    let intervalId = null;

    function formatTime(dateStr) {
        if (!dateStr) return "";
        const date = new Date(dateStr);
        const pad = (num) => String(num).padStart(2,'0');
        return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    function pad(num) { return String(num).padStart(2,'0'); }

    function updateTimer() {
        if (!startTime) return;
        const now = new Date();
        const diff = Math.floor((now - startTime) / 1000);
        const hours = pad(Math.floor(diff / 3600));
        const minutes = pad(Math.floor((diff % 3600) / 60));
        const seconds = pad(diff % 60);
        timerDiv.textContent = `${hours}:${minutes}:${seconds}`;
    }

    async function loadSavedEntry() {
        statusDiv.textContent = "載入暫存資料...";
        try {
            const res = await fetch(SAVE_API);
            const data = await res.json();
            if (data.start && data.description) {
                startTimeDiv.textContent = data.start;
                taskDescDiv.textContent = data.description;
                startTime = new Date(data.start.replace(' ', 'T'));
                if (intervalId) clearInterval(intervalId);
                updateTimer();
                intervalId = setInterval(updateTimer, 1000);
                statusDiv.textContent = "已載入暫存資料";
            } else {
                startTimeDiv.textContent = "--:--";
                taskDescDiv.textContent = "無任務";
                timerDiv.textContent = "00:00:00";
                startTime = null;
                statusDiv.textContent = "尚無暫存資料";
            }
        } catch(err) {
            console.error(err);
            statusDiv.textContent = "讀取暫存資料失敗";
        }
    }

    updateBtn.addEventListener("click", async () => {
        statusDiv.textContent = "更新中...";
        try {
            const res = await fetch(TOGGL_API);
            const data = await res.json();

            if (data.current_timer && data.current_timer.id) {
                const entry = {
                    start: formatTime(data.current_timer.start),
                    description: data.current_timer.description || "無描述"
                };

                startTimeDiv.textContent = entry.start;
                taskDescDiv.textContent = entry.description;
                startTime = new Date(data.current_timer.start);

                // 存入暫存資料
                await fetch(SAVE_API, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(entry)
                });

                // 同步到 Notion
                await fetch("/api/notionPush", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ task: entry.description, startDate: entry.start })
                });

                if (intervalId) clearInterval(intervalId);
                updateTimer();
                intervalId = setInterval(updateTimer, 1000);
                statusDiv.textContent = "已更新 Toggl + Notion ✅";
            } else {
                startTimeDiv.textContent = "--:--";
                taskDescDiv.textContent = "無任務";
                timerDiv.textContent = "00:00:00";
                startTime = null;
                statusDiv.textContent = "目前沒有計時中項目";
            }
        } catch(err) {
            console.error(err);
            statusDiv.textContent = "抓取失敗，請檢查網路或 API";
        }
    });

    window.onload = loadSavedEntry;
</script>

</body>
</html>
